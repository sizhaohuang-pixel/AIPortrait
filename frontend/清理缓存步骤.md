# 清理缓存步骤

> 艹，如果打包后还是请求 localhost，按照这个步骤清理缓存！

## 步骤一：清理编译缓存

1. **关闭微信开发者工具**

2. **删除编译缓存目录**：
   ```
   frontend/unpackage/
   ```

   直接删除整个 `unpackage` 文件夹

## 步骤二：清理微信开发者工具缓存

### Windows 系统

1. **关闭微信开发者工具**

2. **删除以下目录**：
   ```
   C:\Users\你的用户名\AppData\Local\微信开发者工具\User Data\Default\Code Cache
   C:\Users\你的用户名\AppData\Local\微信开发者工具\User Data\Default\Cache
   ```

3. **或者在微信开发者工具中清理**：
   - 打开微信开发者工具
   - 点击菜单：`工具` → `清除缓存` → `清除全部缓存`

### Mac 系统

1. **关闭微信开发者工具**

2. **删除以下目录**：
   ```
   ~/Library/Application Support/微信开发者工具/
   ```

## 步骤三：重新编译

1. **打开 HBuilderX**

2. **重新发行小程序**：
   - 点击菜单：`发行` → `小程序-微信`
   - 等待编译完成

3. **打开微信开发者工具**：
   - 选择编译后的目录：`frontend/unpackage/dist/build/mp-weixin`
   - 点击"编译"按钮

## 步骤四：验证配置

### 方法一：查看编译后的代码

打开文件：
```
frontend/unpackage/dist/build/mp-weixin/services/config.js
```

检查 `baseURL` 是否为 `https://www.bbhttp.com`

### 方法二：查看网络请求

1. 在微信开发者工具中打开"调试器"
2. 切换到"Network"标签
3. 刷新小程序
4. 查看请求的 URL 是否为 `https://www.bbhttp.com`

### 方法三：在代码中打印

在 `App.vue` 的 `onLaunch` 中添加：

```javascript
import { API_CONFIG } from './services/config.js'

export default {
  onLaunch() {
    console.log('=== 当前 API 配置 ===')
    console.log('baseURL:', API_CONFIG.baseURL)
    console.log('==================')
  }
}
```

## 常见问题

### Q1: 清理缓存后还是不行？

**A:** 检查以下几点：

1. **确认配置文件正确**：
   ```javascript
   // frontend/services/config.js
   const PRODUCTION_BASE_URL = 'https://www.bbhttp.com'
   ```

2. **确认条件编译语法正确**：
   ```javascript
   // #ifdef H5
   baseURL: process.env.NODE_ENV === 'production'
       ? PRODUCTION_BASE_URL
       : 'http://localhost:8000',
   // #endif
   // #ifndef H5
   baseURL: PRODUCTION_BASE_URL,
   // #endif
   ```

   注意：`// #ifdef` 和 `// #endif` 必须在行首，不能有缩进！

3. **检查是否有硬编码的 localhost**：
   ```bash
   # 在 frontend 目录下执行
   grep -r "localhost:8000" pages/ services/ --include="*.vue" --include="*.js"
   ```

### Q2: 微信开发者工具显示"不在以下 request 合法域名列表中"

**A:** 这是正常的，需要在微信小程序后台配置服务器域名白名单：

1. 登录微信小程序后台
2. 进入"开发" → "开发管理" → "开发设置"
3. 在"服务器域名"中添加：`https://www.bbhttp.com`

**临时解决方案**：
- 在微信开发者工具中勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

### Q3: 如何确认是否真的在请求生产环境？

**A:** 在微信开发者工具的"Network"标签中查看请求：

- ✅ 正确：`https://www.bbhttp.com/api/portrait/styles`
- ❌ 错误：`http://localhost:8000/api/portrait/styles`

## 老王的建议

1. **每次修改配置后都要清理缓存**
2. **使用微信开发者工具的"清除缓存"功能**
3. **检查编译后的代码，确认配置是否正确**
4. **在生产环境配置域名白名单**

---

**艹，按照这个步骤来，肯定能解决问题！**
