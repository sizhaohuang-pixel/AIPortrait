# 全局路由拦截测试指南

## 测试场景

### 1. 未登录访问需要登录的页面
- [ ] 点击"历史记录" → 提示"请先登录"
- [ ] 点击"上传照片"按钮 → 提示"请先登录"
- [ ] 直接访问生成中页面 → 提示"请先登录"
- [ ] 直接访问预览页面 → 提示"请先登录"

### 2. 登录后访问
- [ ] 登录成功后访问历史记录 → 正常显示
- [ ] 登录后上传照片 → 正常显示
- [ ] 登录后查看生成中 → 正常显示
- [ ] 登录后查看预览 → 正常显示

### 3. 退出登录后
- [ ] 退出登录 → 显示"已退出登录"
- [ ] 再次访问历史记录 → 提示"请先登录"
- [ ] "我的"页面显示"未登录"状态

### 4. 不需要登录的页面
- [ ] 访问首页 → 无需登录，正常显示
- [ ] 访问模板详情 → 无需登录，正常显示
- [ ] 访问"我的"页面 → 无需登录，显示登录按钮

## 配置说明

### 需要登录的页面（在 App.vue 中配置）
```javascript
const authPages = [
  '/pages/upload/index',      // 上传照片
  '/pages/generating/index',  // 生成中
  '/pages/preview/index',     // 预览
  '/pages/history/index'      // 历史记录
]
```

### 添加新页面
如果需要添加新的需要登录的页面，只需在 `authPages` 数组中添加：

```javascript
const authPages = [
  '/pages/upload/index',
  '/pages/generating/index',
  '/pages/preview/index',
  '/pages/history/index',
  '/pages/your-new-page/index'  // 新增页面
]
```

## 实现原理

### 1. 全局拦截
在 `App.vue` 的 `onLaunch` 中设置路由守卫，拦截以下方法：
- `uni.navigateTo()`
- `uni.redirectTo()`
- `uni.reLaunch()`

### 2. 登录检查
访问需要登录的页面时：
1. 检查 `authPages` 列表
2. 如果在列表中，检查登录状态
3. 未登录则显示提示并跳转到登录页
4. 已登录则正常跳转

### 3. 优势
- ✅ 统一管理，易于维护
- ✅ 无需在每个页面单独添加拦截代码
- ✅ 新增页面只需添加一行配置
- ✅ 用户体验统一

## 注意事项

1. **switchTab 不拦截**
   - `uni.switchTab()` 用于 TabBar 页面跳转
   - TabBar 页面（首页、我的）不需要登录
   - 因此不拦截 `switchTab`

2. **页面内部逻辑**
   - 全局拦截只处理页面跳转
   - 页面内部的登录状态判断仍需使用 `isLogin()` 等工具函数
   - 例如："我的"页面显示登录状态

3. **历史记录页面**
   - 虽然有全局拦截，但历史记录页面仍保留了 `requireLogin()` 调用
   - 这是为了在页面 `onShow` 时也能检查登录状态
   - 双重保险，确保安全

## 测试步骤

### 步骤 1：清除登录状态
```javascript
// 在浏览器控制台或小程序调试器中执行
uni.removeStorageSync('token')
uni.removeStorageSync('userInfo')
```

### 步骤 2：测试未登录拦截
1. 重启应用
2. 点击"我的" → 点击"历史记录"
3. 应该显示"请先登录"提示

### 步骤 3：测试登录后访问
1. 点击"去登录"
2. 输入手机号和验证码
3. 登录成功后访问历史记录
4. 应该正常显示

### 步骤 4：测试退出登录
1. 在"我的"页面点击"退出"
2. 确认退出
3. 再次访问历史记录
4. 应该提示"请先登录"

---

**测试完成后请在上面的复选框中打勾 ✓**
